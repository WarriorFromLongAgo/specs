### 👣 正确管理 OP mainnet 整个发布过程的步骤:

## 1. 治理阈值检查

- 作为第一步,你需要查看治理阈值,以了解你的功能是否会通过,并理解你的提案的所有治理需求。
    
    *关于这个主题的好的阅读材料可以在这里找到:[OPerating manual](https://github.com/ethereum-optimism/OPerating-manual/tree/main?tab=readme-ov-file), [Optimism Agora](https://vote.optimism.io/)*
    
### 这一步骤的流程说明:

哪些变更需要治理投票的阈值是基于链法则中的用户保护条款。总的来说,这些保护包括:

1. **状态转换和消息有效性:** OP 链状态转换或发送到 OP 链或从 OP 链发送的跨链消息必须遵循最新治理批准的 OP Stack 版本的规则。这意味着对区块推导函数或信使合约的更改总是需要进行治理投票。

2. **安全性、正常运行时间和活跃度:** 区块生产、排序和桥接必须满足所有 OP 链的安全性、正常运行时间和活跃度的统一标准。这意味着可能导致用户无法交易的更改(例如,将 gas 限制更改为不可接受的值)需要进行治理投票。

3. **通用的、治理批准的升级:** OP 链必须在治理批准的 OP Stack 版本下一起升级。因此,任何不向后兼容的升级都需要进行治理投票。

## 2. 完成开发端的所有工作

- 通过工程标准的所有检查 - 为了宣布开发端的工作完成,你需要完成以下列出的步骤:
  - 你的代码实现完整 🏁
  - 代码有自动化测试,并有良好的解释
  - 代码在功能标志后面 🚩
  - 你已更新协议规范并与安全团队分享以供审查: https://github.com/ethereum-optimism/specs/tree/main/specs
  - 代码在你的内部开发网络上运行了必要的时间以测试所有功能
  - 代码在 Goerli 或 Sepolia 上运行了一周,没有遇到任何错误/性能/稳定性问题

    ## 3. 硬分叉准备(可选)

- 准备硬分叉 *[如果需要 - 当我们向我们的堆栈添加重大/协议级更改时需要硬分叉]*
   - 创建命名的硬分叉
   - 代码已配置为随命名的硬分叉激活
   - 准备故障证明系统的升级

    ## 4. 完成安全标准和标准检查

-   通过安全标准
    - 负责发布的 TL 需要编写一个[故障模式分析 (FMAs)](https://www.notion.so/Failure-Mode-Analyses-FMAs-1fb9f65a13e542e5b48af6c850763494?pvs=21) (FMA),描述发布的故障模式和恢复路径。
        - [如果需要] 安全团队已签署 FMA
    - [如果需要] 审计已完成并修复问题
    - [如果需要] 更新安全监控和区块历史完整性检查以支持新功能。

## 5. 完成治理标准和标准检查

-   [如果需要投票] 通过治理标准
    - 创建治理提案并在[这里](https://gov.optimism.io/c/other-proposals/protocol-upgrade/58)分享
    - FND 批准提案
    - 在治理论坛上发布提案草案
    - 最终确定草案,在所有相关论坛上分享,并解决所有公开评论

# 我们提到的所有必需检查的流程步骤说明:

## 1. 确定治理阈值(协议升级框架)

<aside>
⚠️ 所有需要安全委员会采取行动的升级都需要治理投票,除非是紧急错误修复。

</aside>

哪些变更需要治理投票的阈值是基于链法则中的用户保护条款。总的来说,这些保护包括:

1. **状态转换和消息有效性:** OP 链状态转换或发送到 OP 链或从 OP 链发送的跨链消息必须遵循最新治理批准的 OP Stack 版本的规则。这意味着对区块推导函数或信使合约的更改总是需要进行治理投票。

2. **安全性、正常运行时间和活跃度:** 区块生产、排序和桥接必须满足所有 OP 链的安全性、正常运行时间和活跃度的统一标准。这意味着可能导致用户无法交易的更改(例如,将 gas 限制更改为不可接受的值)需要进行治理投票。

3. **通用的、治理批准的升级:** OP 链必须在治理批准的 OP Stack 版本下一起升级。因此,任何不向后兼容的升级都需要进行治理投票。

使用这个框架,我们可以定义以下大致的升级类型,并确定每种升级类型是否需要治理投票。如果你不确定某个升级是否需要治理批准,请在论坛上请求代表反馈。

- **共识变更**
    
    **需要投票:** 是
    
    共识变更修改状态转换函数或消息有效性。因此,它们必须得到治理批准以满足上述第一条保护。
    
    例如:
    
    - Bedrock
    - EIP-4844
    - Shanghai
    - 任何修改安全委员会控制下的合约的 L1 升级。安全委员会不能对 L1 进行任何更改,除非这些更改得到治理批准*或*是由于活跃或即将发生的安全问题。
 
- **预部署更新**
    
    **需要投票:** 是
    
    预部署更新必须得到治理批准,以满足上述第三条保护。更具体地说,对预部署的更改必须在所有 OP 链上推出,以防止一个链上的功能与其他所有链不同。
    
- **跨链合约**
    
    **需要投票:** 否
    
    "跨链合约"指的是像 Gnosis SAFE 或 `create2deployer` 这样在多个链上以相同地址部署的智能合约。这些合约不需要治理投票,因为任何人都可以随时在任何链上部署它们。即使我们决定将这些合约添加到创世状态,这也是正确的,因为有人总可以在链上线后部署它们。
    
    请注意,对 `0x42...` 命名空间的任何更改*确实*需要通过治理,任何需要不规则状态转换的合约部署也是如此。
    
- **参数更新**
    
    **需要投票:** 取决于变更
    
    影响上述第一或第二条保护的参数更新将需要得到治理批准。例如,设置 gas 限制或更改 EIP-1559 参数将需要治理批准,因为修改这些参数可能会阻止用户进行交易。
    
    例子:
    
    - 更新 ProxyAdmin/challenger/guardian 地址需要治理投票。
    - 更新 gas 参数需要治理投票,直到它们被明确配置为可由链管理员配置
    - 更新 batcher/proposer 地址(在已经在允许列表中的地址之间)不需要治理投票,只要它们在治理批准的地址集合内
- **非共识客户端功能**
    
    **需要投票:** 否
    
    网络范围的功能引入了可能需要与替代客户端开发者协调的功能,但不存在链分裂的风险。因此,只要这些变更是向后兼容的并且满足我们的工程严格性标准,它们就满足上述所有三个用户保护。
    
    例子:
    - 快照同步

- **影响交易包含/排序的变更**
    
    **需要投票:** **可选** - 你的提案应该与其他团队分享并在相关同步会议上展示
    
    尽管内存池在技术上不是共识的一部分,但它影响交易被包含到链中的方式,可能会对用户体验产生负面影响。因此,影响交易排序的单方面变更违反了上述第二条保护,因此需要投票。如果社区发现正在运行非标准排序软件,这是从排序器允许列表中移除的理由。
    例子:

- 转向公共内存池
- 运行自定义 PBS/交易池软件
- **非共识、无需协调、不影响排序的变更**
    
    **需要投票:** 否
    
    这些变更是任何不修改共识或需要协调的变更的总称。这些变更可以在没有治理输入的情况下单方面推出,因为它们不影响上述任何保护。

  
<aside>
📌 上述集合并不总是互斥的。如果给定的变更可能属于多个类别,如果其中任何一个需要投票,那么这个变更就需要投票。如果你不确定某事是否需要治理投票,请在相关治理论坛上检查

</aside>

<aside>

📌 所有需要安全委员会采取行动的升级都需要治理投票,除非是紧急错误修复。
</aside>
    

***注意**: 如果你不确定某事是否需要治理投票,请在我们的核心贡献者 Discord 上询问或与 @Ben Edgington,  @Bobby Dresser 或 @Ben Jones 确认进一步的步骤*

## 2. 进行实施工作

主网就绪从开发开始。我们使用稳定的主干开发模型,所以我们合并的所有内容 - 即使是正在进行中的功能 - 都将在某人的生产环境中运行。这意味着我们必须确保所有更改通过 CI,接受代码审查,并为任何新的或修改的功能有自动化测试。

这还要求将破坏性变更放在功能标志后面,直到它们准备好供更广泛的群体测试和使用。

## 3. 通过工程标准

无论是否需要投票,我们发布到主网的所有软件都必须通过以下就绪标准。这些标准的目标是让*我们的内部团队*感到舒适地将变更推送到主网。因此,一些变更可能涉及的不仅仅是这里列出的内容。

随着开发的进行,你应该能够完成以下开发检查:

- [ ]  你的代码是否处于实现完整状态
- [ ]  你的代码是否有自动化测试
- [ ]  你的代码是否在专用功能标志后面
- [ ]  你的更改是否与故障证明系统兼容?
- [ ]  你是否在内部开发网络上运行了你的代码足够长的时间(取决于你与其他贡献者的协议)
- [ ]  你的代码是否在 Sepolia 测试网上运行了一周或更长时间?

如果更改没有通过治理阈值,你可以在这里停止并直接将你的更改发布到主网。如果它们通过了阈值,请继续阅读。

## 3.5. 添加到或创建命名的硬分叉

为了使升级过程更容易,我们将把更改批量放在一个命名的硬分叉中。一个例子是 Regolith 硬分叉,我们在其中批量处理了收据处理和存款 gas 的修复。

如果不存在命名的硬分叉,我们需要创建一个。这涉及对 `op-geth` 中的链配置和 `op-node` 中的 rollup 配置进行一些更改。然后,需要配置硬分叉更改以在硬分叉的激活时间激活。

- [ ]  准备硬分叉
    - [ ]  创建命名的硬分叉或使用现有名称 - 在此链接下检查名称列表: https://github.com/ethereum-optimism/specs/tree/main/specs/protocol
    - [ ]  代码已配置为随命名的硬分叉激活

## 4. 通过安全标准

<aside>
我们(作为安全团队)强烈建议在流程早期就开始安全标准的工作,以避免可能导致延迟的意外。

</aside>

负责发布的技术负责人需要决定并获得项目委员会的批准,是否编写 FMA 以及是否需要安全团队对 FMA 的批准。如果需要 FMA:

- [ ]  编写文档 [故障模式和恢复路径分析](https://www.notion.so/Failure-Mode-Analyses-FMAs-1fb9f65a13e542e5b48af6c850763494?pvs=21)
- [ ]  [如果需要] 安全团队已签署分析
- [ ]  [如果适用] 审计已完成并修复问题
    
### 故障模式和恢复路径分析
    
这个分析提供了开发人员引入的变更所涉及的风险的描述,以及可以采取的预防问题或在问题发生时恢复的缓解措施。
    
我们的分析模板将指导你完成这个过程,这应该在审计或测试网部署之前完成。请按照 [故障模式分析 (FMAs)](https://www.notion.so/Failure-Mode-Analyses-FMAs-1fb9f65a13e542e5b48af6c850763494?pvs=21) 中的流程创建故障模式分析。
    
### 审计要求

决定是否需要审计的框架在[这个指南](https://gov.optimism.io/t/op-labs-audit-framework-when-to-get-external-security-review-and-how-to-prepare-for-it/6864)中描述。

## 5. 制定治理提案

请注意,治理提案是*全有或全无的:*如果提案的一个方面失败,那么整个提案就失败,必须重新投票。

- [ ]  使用下面的模板创建治理提案
    - 升级提案需要指向一些功能完整、冻结的代码体 — 可以是 git 标签、特定提交等
- [ ]  以草稿形式在治理论坛上以你的名义发布提案
- [ ]  FND 将寻找 4 个代表来批准提案进行投票

### 治理提案模板

使用官方的[标准提案模板](https://gov.optimism.io/t/standard-proposal-template-optimism-token-house/5443)格式化和分享你的治理帖子。

使用 [Canyon](https://gov.optimism.io/t/final-upgrade-proposal-2-canyon-network-upgrade/7088) / [Delta](https://gov.optimism.io/t/final-upgrade-proposal-3-delta-network-upgrade/7310) 或 [Ecotone](https://gov.optimism.io/t/upgrade-proposal-5-ecotone-network-upgrade/7669) 治理帖子作为指导,了解应该说什么。

一些编写治理帖子的有用提示:

- 包括一个介绍,描述你作为核心开发者的隶属关系。它应该类似于 Canyon 治理帖子中所做的。
- 在安全考虑部分,使用 FMA 和[审计框架](https://gov.optimism.io/t/op-labs-audit-framework-when-to-get-external-security-review-and-how-to-prepare-for-it/6864)来描述为什么我们需要或不需要审计,以及我们如何保护系统。
- 在行动计划部分确保描述激活时间、软件版本,以及变更部署到哪些测试网。
- 在行动计划部分确保链接到正在部署的 monorepo 提交哈希。
- 如果相关,链接到你用于开发的规范,以展示你通往主网的完整路径。
- 包括任何相关数据以显示提案的影响。

### 即将到来的变更: 区块空间章程

治理季节 6 引入了[区块空间章程](https://gov.optimism.io/t/season-6-introducing-blockspace-charters-superchain-first-governance/8133)的概念。区块空间章程提供了一个框架来定义特定类型的区块空间如何治理,以及每种区块空间提供的属性和保证。链接的治理帖子概述了每个章程的三个关键组成部分。

例如,[标准区块空间章程](https://gov.optimism.io/t/season-6-draft-standard-rollup-charter/8135)定义了链必须满足的链上和链下标准,以被视为标准链。这些标准包括桥接偿付能力检查、唯一链 ID 检查等。它还描述了一些关于管理员密钥恢复、排序器审查、gas 限制等的指导政策。最终结果是一份文档,概述了标准链区块空间的一套强有力的保证和规则。

一旦引入区块空间章程,**所有升级提案都需要指定要升级的区块空间章程。**升级区块空间章程的步骤如下:

- 创建一个拉取请求,更新章程的文本和更新后的规则,以及超级链注册表中规则的更新实现。
    - 章程的文本位于 [Operating Manual](https://github.com/ethereum-optimism/OPerating-manual/tree/main) 仓库中。
- 在提案的影响摘要部分包括区块空间章程变更的理由。
- 包括一个全面的理由,说明先前版本章程中的所有预先承诺仍然被升级所保留。

## 6. 实施你的发布投票(如果与 OP stack 的治理组织协调)

- [ ]  添加硬分叉激活时间
- [ ]  安排合约部署
